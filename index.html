<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­è‚²ã¦è‹±å˜èª - iPhoneç‰ˆ</title>
    <meta name="description" content="5000èªã®å­è‚²ã¦è‹±å˜èªå­¦ç¿’ã‚¢ãƒ—ãƒª">
    <meta name="theme-color" content="#667eea">

    <!-- PWAè¨­å®š -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å­è‚²ã¦è‹±å˜èª">
    
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .header {
            background: rgba(0,0,0,0.1);
            padding: 10px;
            text-align: center;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .slide-container {
            flex: 1;
            background: white;
            margin: 10px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: calc(100vh - 200px);
            position: relative;
            touch-action: pan-y;
        }
        
        .word-japanese {
            font-size: clamp(36px, 8vw, 60px);
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            line-height: 1.2;
        }
        
        .word-english {
            font-size: clamp(28px, 6vw, 48px);
            font-weight: bold;
            color: #667eea;
            margin-bottom: 25px;
            line-height: 1.2;
        }
        
        .example-japanese {
            font-size: clamp(16px, 4vw, 24px);
            color: #555;
            margin-bottom: 15px;
            line-height: 1.4;
            padding: 0 10px;
        }
        
        .example-english {
            font-size: clamp(14px, 3.5vw, 20px);
            color: #777;
            font-style: italic;
            line-height: 1.4;
            padding: 0 10px;
        }
        
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            padding: 15px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
            min-width: 60px;
            white-space: nowrap;
            -webkit-appearance: none;
            appearance: none;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn:active:not(:disabled) {
            transform: scale(0.95);
            background: #5a6fd8;
        }
        
        .btn-icon {
            font-size: 20px;
            padding: 12px;
            background: transparent;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .btn-icon:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.1);
        }
        
        .progress {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .category-title {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background: rgba(102, 126, 234, 0.9);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .bookmark-btn {
            position: absolute;
            bottom: 120px;
            right: 20px;
            font-size: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 15px;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            -webkit-appearance: none;
            appearance: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .bookmark-btn:active {
            transform: scale(0.9);
        }
        
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 20px;
            color: white;
        }
        
        .settings-content {
            background: white;
            color: black;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .setting-item {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .setting-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .setting-item label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        
        .setting-item select,
        .setting-item input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            background: white;
            color: #000;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            -webkit-appearance: none;
            appearance: none;
            background: white;
            border: 2px solid #ddd;
            border-radius: 4px;
            position: relative;
        }

        .checkbox-item input[type="checkbox"]:checked {
            background: #667eea;
            border-color: #667eea;
        }

        .checkbox-item input[type="checkbox"]:checked::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
            font-weight: bold;
            position: absolute;
            top: -2px;
            left: 3px;
        }

        .checkbox-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .checkbox-row .checkbox-item {
            flex: 0 0 auto;
        }

        .checkbox-row .checkbox-item label {
            font-weight: normal;
            margin: 0;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            -webkit-appearance: none;
            appearance: none;
            background: white;
            border: 2px solid #ddd;
            border-radius: 50%;
            position: relative;
        }

        .radio-item input[type="radio"]:checked {
            border-color: #667eea;
        }

        .radio-item input[type="radio"]:checked::after {
            content: '';
            width: 10px;
            height: 10px;
            background: #667eea;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .radio-row {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .radio-row .radio-item label {
            font-weight: normal;
            margin: 0;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .search-box input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
        }

        .search-box button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
            white-space: nowrap;
        }

        .search-box button:active {
            transform: scale(0.95);
            background: #5a6fd8;
        }

        .search-result {
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            font-size: 14px;
            color: #666;
            text-align: center;
        }

        .close-settings {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .close-settings:active {
            transform: scale(0.95);
        }
        
        .audio-indicator {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            font-size: 14px;
            z-index: 50;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 18px;
        }
        
        .error {
            text-align: center;
            padding: 30px;
            color: #ff6b6b;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h3 style="margin: 5px 0;">å­è‚²ã¦è‹±å˜èªå­¦ç¿’ ğŸ“š</h3>
    </div>
    
    <div class="slide-container" id="slideContainer">
        <div class="loading" id="loading">
            ã‚¢ãƒ—ãƒªã‚’æº–å‚™ä¸­...<br>
            <small>å°‘ã€…ãŠå¾…ã¡ãã ã•ã„</small>
        </div>
        
        <div id="contentArea" style="display: none; width: 100%;">
            <div class="progress" id="progress">1 / 5000</div>
            <div class="category-title" id="categoryTitle">åŒ»ç™‚ãƒ»å¥åº·</div>

            <div class="word-japanese" id="wordJapanese">ç†±</div>
            <div class="word-english" id="wordEnglish">fever</div>
            <div class="example-japanese" id="exampleJapanese">ãƒãƒã€ãŠç†±ã‚’æ¸¬ã£ã¦ãã‚Œã‚‹ï¼Ÿ</div>
            <div class="example-english" id="exampleEnglish">Mom, can you check my fever?</div>

            <button class="bookmark-btn" id="bookmarkBtn" onclick="toggleBookmark()" title="ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯">â˜†</button>

            <div class="audio-indicator" id="audioIndicator">ğŸ”Š éŸ³å£°å†ç”Ÿä¸­...</div>
        </div>
    </div>
    
    <div class="controls" id="controls" style="display: none;">
        <button class="btn-icon" onclick="previousWord()" title="å‰ã®å˜èª">â—€</button>
        <button class="btn" onclick="togglePlayPause()" id="playBtn">â–¶ å†ç”Ÿ</button>
        <button class="btn" onclick="toggleAutoPlay()" id="autoBtn">â–¶ è‡ªå‹•</button>
        <button class="btn" onclick="showSettings()" id="settingsBtn">âš™ï¸ è¨­å®š</button>
        <button class="btn-icon" onclick="nextWord()" title="æ¬¡ã®å˜èª">â–¶</button>
    </div>
    
    <!-- è¨­å®šãƒ‘ãƒãƒ« -->
    <div class="settings-panel" id="settingsPanel">
        <h2 style="text-align: center; margin-top: 0;">è¨­å®š</h2>
        
        <div class="settings-content">
            <div class="setting-item">
                <label style="font-weight: bold; margin-bottom: 8px; display: block;">å˜èªæ¤œç´¢</label>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="æ—¥æœ¬èªã¾ãŸã¯è‹±èªã§æ¤œç´¢">
                    <button onclick="searchWord()">æ¤œç´¢</button>
                </div>
                <div id="searchResult" class="search-result" style="display: none;"></div>
            </div>

            <div class="setting-item">
                <label for="categorySelect">ã‚«ãƒ†ã‚´ãƒªãƒ¼:</label>
                <select id="categorySelect" onchange="changeCategory()">
                    <option value="all">ã™ã¹ã¦</option>
                </select>
            </div>
            
            <div class="setting-item">
                <label for="speechRate">èª­ã¿ä¸Šã’é€Ÿåº¦:</label>
                <select id="speechRate">
                    <option value="0.7">ã‚†ã£ãã‚Š</option>
                    <option value="1.0" selected>æ™®é€š</option>
                    <option value="1.3">é€Ÿã„</option>
                </select>
            </div>
            
            <div class="setting-item">
                <div class="checkbox-item">
                    <input type="checkbox" id="randomMode" onchange="toggleRandomMode()">
                    <label for="randomMode">ãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿ</label>
                </div>
            </div>
            
            <div class="setting-item">
                <label style="font-weight: bold; margin-bottom: 10px; display: block;">èª­ã¿ä¸Šã’è¨­å®š</label>

                <label style="display: block; margin-bottom: 5px; font-size: 14px;">ç¨®é¡:</label>
                <div class="checkbox-row">
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeJpWord" checked onchange="saveSettings()">
                        <label for="includeJpWord">æ—¥å˜</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeEnWord" checked onchange="saveSettings()">
                        <label for="includeEnWord">è‹±å˜</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeJpSentence" checked onchange="saveSettings()">
                        <label for="includeJpSentence">æ—¥æ–‡</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeEnSentence" checked onchange="saveSettings()">
                        <label for="includeEnSentence">è‹±æ–‡</label>
                    </div>
                </div>

                <label style="display: block; margin-bottom: 5px; margin-top: 10px; font-size: 14px;">èª­ã¿é †:</label>
                <div class="radio-row">
                    <div class="radio-item">
                        <input type="radio" id="readOrderEnJp" name="readOrder" value="en-jp" checked onchange="saveSettings()">
                        <label for="readOrderEnJp">è‹±â†’æ—¥</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="readOrderJpEn" name="readOrder" value="jp-en" onchange="saveSettings()">
                        <label for="readOrderJpEn">æ—¥â†’è‹±</label>
                    </div>
                </div>

                <label style="display: block; margin-bottom: 5px; margin-top: 10px; font-size: 14px;">è‹±èª:</label>
                <div class="radio-row">
                    <div class="radio-item">
                        <input type="radio" id="englishRepeat2" name="englishRepeat" value="2" checked onchange="saveSettings()">
                        <label for="englishRepeat2">ï¼’å›</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="englishRepeat1" name="englishRepeat" value="1" onchange="saveSettings()">
                        <label for="englishRepeat1">ï¼‘å›</label>
                    </div>
                </div>

                <button class="btn" onclick="resetPlaybackSettings()" style="margin-top: 10px; width: 100%;">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«æˆ»ã™</button>
            </div>

            <div class="setting-item">
                <div class="checkbox-item">
                    <input type="checkbox" id="bookmarkMode" onchange="toggleBookmarkMode()">
                    <label for="bookmarkMode">ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã®ã¿è¡¨ç¤º</label>
                </div>
                <small style="color: #666; margin-top: 5px; display: block;">â­ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å¾©ç¿’ã—ãŸã„å˜èªã‚’ä¿å­˜</small>
            </div>
        </div>
        
        <button class="close-settings" onclick="hideSettings()">è¨­å®šã‚’é–‰ã˜ã‚‹</button>
    </div>

    <!-- 5000èªã®èªå½™ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ -->
    <script src="vocabulary.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentIndex = 0;
        let isAutoPlaying = false;
        let filteredVocabulary = [];
        let isRandomMode = false;
        let randomIndexes = [];
        let bookmarkedWords = new Set();
        let isBookmarkMode = false;
        let isPlaying = false;
        let isTransitioning = false; // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆä¸­ãƒ•ãƒ©ã‚°
        let wakeLock = null; // ç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ç”¨
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºé–¢æ•°
        function showError(message) {
            console.error('Error:', message);
            document.getElementById('loading').innerHTML = `
                <div class="error">
                    ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ<br>
                    <small>${message}</small><br>
                    <button onclick="initializeApp()" style="margin-top: 15px; padding: 10px 20px; border: none; border-radius: 5px; background: #667eea; color: white; cursor: pointer;">
                        å†è©¦è¡Œ
                    </button>
                    <button onclick="location.reload()" style="margin-top: 15px; margin-left: 10px; padding: 10px 20px; border: none; border-radius: 5px; background: #ff6b6b; color: white; cursor: pointer;">
                        å†èª­ã¿è¾¼ã¿
                    </button>
                </div>
            `;
        }
        
        // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
        function initializeApp() {
            try {
                console.log('ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–ä¸­...');

                // èªå½™ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªï¼ˆè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
                if (typeof vocabulary === 'undefined') {
                    throw new Error('vocabulary.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚index.htmlã¨vocabulary.jsãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }

                if (!Array.isArray(vocabulary)) {
                    throw new Error('èªå½™ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚vocabularyã¯é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
                }

                if (vocabulary.length === 0) {
                    throw new Error('èªå½™ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚vocabulary.jsã®å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }

                console.log(`âœ“ èªå½™ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ: ${vocabulary.length}èª`);

                filteredVocabulary = vocabulary;
                
                // UIåˆæœŸåŒ–
                initializeCategoryDropdown();
                loadBookmarks();
                loadSettings();
                displayCurrentWord();
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éš ã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
                document.getElementById('loading').style.display = 'none';
                document.getElementById('contentArea').style.display = 'block';
                document.getElementById('controls').style.display = 'flex';
                
                // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
                setupTouchEvents();
                
                console.log('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†');
                
                // éŸ³å£°åˆæˆã®æº–å‚™
                if ('speechSynthesis' in window) {
                    console.log('éŸ³å£°åˆæˆæ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™');
                } else {
                    console.warn('éŸ³å£°åˆæˆæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError(error.message);
            }
        }
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
        function initializeCategoryDropdown() {
            try {
                const categories = [...new Set(vocabulary.map(word => word.category))];
                const categorySelect = document.getElementById('categorySelect');
                
                if (!categorySelect) {
                    throw new Error('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                categorySelect.innerHTML = '';
                
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'ã™ã¹ã¦';
                categorySelect.appendChild(allOption);
                
                categories.sort().forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
                
                console.log(`ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆæœŸåŒ–å®Œäº†: ${categories.length}ã‚«ãƒ†ã‚´ãƒªãƒ¼`);
            } catch (error) {
                console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼å¤‰æ›´
        function changeCategory() {
            try {
                const selectedCategory = document.getElementById('categorySelect').value;

                if (selectedCategory === 'all') {
                    filteredVocabulary = vocabulary;
                } else {
                    filteredVocabulary = vocabulary.filter(word => word.category === selectedCategory);
                }

                // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ã•ã‚‰ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (isBookmarkMode) {
                    applyBookmarkFilter();
                }

                console.log(`ã‚«ãƒ†ã‚´ãƒªãƒ¼å¤‰æ›´: ${selectedCategory}, ${filteredVocabulary.length}èª`);

                if (isRandomMode) {
                    generateRandomIndexes();
                }

                currentIndex = 0;
                displayCurrentWord();
                saveSettings();
            } catch (error) {
                console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleRandomMode() {
            try {
                isRandomMode = document.getElementById('randomMode').checked;
                console.log(`ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰: ${isRandomMode ? 'ON' : 'OFF'}`);
                
                if (isRandomMode) {
                    generateRandomIndexes();
                }
                
                currentIndex = 0;
                displayCurrentWord();
                saveSettings();
            } catch (error) {
                console.error('ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆ
        function generateRandomIndexes() {
            try {
                randomIndexes = [];
                for (let i = 0; i < filteredVocabulary.length; i++) {
                    randomIndexes.push(i);
                }
                
                // Fisher-Yatesã‚·ãƒ£ãƒƒãƒ•ãƒ«
                for (let i = randomIndexes.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [randomIndexes[i], randomIndexes[j]] = [randomIndexes[j], randomIndexes[i]];
                }
                
                console.log('ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆå®Œäº†');
            } catch (error) {
                console.error('ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ç¾åœ¨ã®å˜èªè¡¨ç¤º
        function displayCurrentWord() {
            try {
                if (!filteredVocabulary || filteredVocabulary.length === 0) {
                    console.log('è¡¨ç¤ºã™ã‚‹èªå½™ãŒã‚ã‚Šã¾ã›ã‚“');
                    document.getElementById('wordJapanese').textContent = isBookmarkMode ? 'ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“' : 'èªå½™ãŒã‚ã‚Šã¾ã›ã‚“';
                    document.getElementById('wordEnglish').textContent = '';
                    document.getElementById('exampleJapanese').textContent = isBookmarkMode ? 'â­ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å˜èªã‚’ä¿å­˜ã—ã¦ãã ã•ã„' : '';
                    document.getElementById('exampleEnglish').textContent = '';
                    return;
                }

                const actualIndex = isRandomMode ? randomIndexes[currentIndex] : currentIndex;
                const word = filteredVocabulary[actualIndex];

                if (!word) {
                    console.error('å˜èªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', actualIndex);
                    return;
                }

                document.getElementById('wordJapanese').textContent = word.jp || '';
                document.getElementById('wordEnglish').textContent = word.en || '';
                document.getElementById('exampleJapanese').textContent = word.exampleJp || '';
                document.getElementById('exampleEnglish').textContent = word.exampleEn || '';
                document.getElementById('progress').textContent = `${currentIndex + 1} / ${filteredVocabulary.length}`;
                document.getElementById('categoryTitle').textContent = word.category || '';

                // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                updateBookmarkButton();
                // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ›´æ–°
                updateButtonStates();

            } catch (error) {
                console.error('å˜èªè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // å†ç”Ÿ/ä¸€æ™‚åœæ­¢ã®åˆ‡ã‚Šæ›¿ãˆ
        function togglePlayPause() {
            if (isPlaying) {
                pausePlayback();
            } else {
                playCurrentWord();
            }
        }

        // ä¸€æ™‚åœæ­¢
        function pausePlayback() {
            speechSynthesis.cancel();
            isPlaying = false;
            const playBtn = document.getElementById('playBtn');
            playBtn.textContent = 'â–¶ å†ç”Ÿ';
            document.getElementById('audioIndicator').style.display = 'none';
        }

        // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ›´æ–°
        function updateButtonStates() {
            try {
                const playBtn = document.getElementById('playBtn');
                const autoBtn = document.getElementById('autoBtn');

                if (!playBtn || !autoBtn) return; // ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

                if (isAutoPlaying) {
                    playBtn.disabled = true;
                } else {
                    playBtn.disabled = false;
                }
            } catch (error) {
                // åˆæœŸåŒ–ä¸­ã¯ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
                console.log('ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°ã‚¹ã‚­ãƒƒãƒ—');
            }
        }

        // èª­ã¿ä¸Šã’ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å–å¾—
        function getPlaybackSequence(word) {
            const speechRate = parseFloat(document.getElementById('speechRate').value);

            // ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚’å–å¾—
            const includeJpWord = document.getElementById('includeJpWord').checked;
            const includeEnWord = document.getElementById('includeEnWord').checked;
            const includeJpSentence = document.getElementById('includeJpSentence').checked;
            const includeEnSentence = document.getElementById('includeEnSentence').checked;
            const readOrder = document.querySelector('input[name="readOrder"]:checked').value;
            const englishRepeat = parseInt(document.querySelector('input[name="englishRepeat"]:checked').value);

            const sequence = [];

            // èª­ã¿ä¸Šã’é …ç›®ã‚’æº–å‚™
            const items = {
                jpWord: { text: word.jp, lang: 'ja-JP', delay: 500 },
                enWord: { text: word.en, lang: 'en-US', delay: 500 },
                jpSentence: { text: word.exampleJp, lang: 'ja-JP', delay: 500 },
                enSentence: { text: word.exampleEn, lang: 'en-US', delay: 500 }
            };

            if (readOrder === 'en-jp') {
                // è‹±â†’æ—¥ã®é †åº
                // è‹±èªå˜èª
                if (includeEnWord) {
                    sequence.push({ ...items.enWord, rate: speechRate });
                }
                // æ—¥æœ¬èªå˜èª
                if (includeJpWord) {
                    sequence.push({ ...items.jpWord, rate: speechRate });
                }
                // è‹±èªå˜èªï¼ˆ2å›ç›®ï¼‰
                if (includeEnWord && englishRepeat === 2) {
                    sequence.push({ ...items.enWord, rate: speechRate });
                }
                // è‹±èªä¾‹æ–‡
                if (includeEnSentence) {
                    sequence.push({ ...items.enSentence, rate: speechRate, delay: 700 });
                }
                // æ—¥æœ¬èªä¾‹æ–‡
                if (includeJpSentence) {
                    sequence.push({ ...items.jpSentence, rate: speechRate });
                }
                // è‹±èªä¾‹æ–‡ï¼ˆ2å›ç›®ï¼‰
                if (includeEnSentence && englishRepeat === 2) {
                    sequence.push({ ...items.enSentence, rate: speechRate });
                }
            } else {
                // æ—¥â†’è‹±ã®é †åº
                // æ—¥æœ¬èªå˜èª
                if (includeJpWord) {
                    sequence.push({ ...items.jpWord, rate: speechRate });
                }
                // è‹±èªå˜èª
                if (includeEnWord) {
                    sequence.push({ ...items.enWord, rate: speechRate });
                }
                // è‹±èªå˜èªï¼ˆ2å›ç›®ï¼‰
                if (includeEnWord && englishRepeat === 2) {
                    sequence.push({ ...items.enWord, rate: speechRate });
                }
                // æ—¥æœ¬èªä¾‹æ–‡
                if (includeJpSentence) {
                    sequence.push({ ...items.jpSentence, rate: speechRate, delay: 700 });
                }
                // è‹±èªä¾‹æ–‡
                if (includeEnSentence) {
                    sequence.push({ ...items.enSentence, rate: speechRate });
                }
                // è‹±èªä¾‹æ–‡ï¼ˆ2å›ç›®ï¼‰
                if (includeEnSentence && englishRepeat === 2) {
                    sequence.push({ ...items.enSentence, rate: speechRate });
                }
            }

            // æœ€å¾Œã®é …ç›®ã«ãƒãƒ¼ã‚¯
            if (sequence.length > 0) {
                sequence[sequence.length - 1].isLast = true;
            }

            return sequence.length > 0 ? sequence : [{ text: word.jp, lang: 'ja-JP', rate: speechRate, isLast: true }];
        }

        // éŸ³å£°å†ç”Ÿ
        function playCurrentWord() {
            try {
                if (!filteredVocabulary || filteredVocabulary.length === 0) return;

                const actualIndex = isRandomMode ? randomIndexes[currentIndex] : currentIndex;
                const word = filteredVocabulary[actualIndex];

                if (!word) return;

                speechSynthesis.cancel();
                isPlaying = true;

                const playBtn = document.getElementById('playBtn');
                playBtn.textContent = 'â¸ åœæ­¢';

                const audioIndicator = document.getElementById('audioIndicator');
                audioIndicator.style.display = 'block';

                currentPlaybackSequence = getPlaybackSequence(word);
                playSequence(currentPlaybackSequence);

            } catch (error) {
                console.error('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
                pausePlayback();
            }
        }

        // ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å†ç”Ÿ
        function playSequence(items) {
            let index = 0;

            function playNext() {
                if (!isPlaying || index >= items.length) {
                    finishPlayback();
                    return;
                }

                const item = items[index];
                const utterance = new SpeechSynthesisUtterance(item.text);
                utterance.lang = item.lang;
                utterance.rate = item.rate;

                utterance.onend = () => {
                    if (item.isLast) {
                        finishPlayback();
                    } else if (!isPlaying) {
                        pausePlayback();
                    } else {
                        index++;
                        setTimeout(playNext, item.delay || 0);
                    }
                };

                utterance.onerror = (event) => {
                    // "interrupted"ã¯æ„å›³çš„ãªã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãªã©ï¼‰ãªã®ã§ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã‚ãªã„
                    if (event.error === 'interrupted' || isTransitioning) {
                        console.log('éŸ³å£°å†ç”ŸãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸï¼ˆæ„å›³çš„ï¼‰');
                        return;
                    }
                    console.error('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', event);
                    pausePlayback();
                };

                speechSynthesis.speak(utterance);
            }

            playNext();
        }

        // å†ç”Ÿå®Œäº†æ™‚ã®å‡¦ç†
        function finishPlayback() {
            isPlaying = false;
            document.getElementById('audioIndicator').style.display = 'none';

            if (isAutoPlaying) {
                // è‡ªå‹•å†ç”Ÿãƒ¢ãƒ¼ãƒ‰ï¼šçŸ­ã„å¾…æ©Ÿæ™‚é–“ã§æ¬¡ã®å˜èªã¸
                setTimeout(() => {
                    if (isAutoPlaying) {
                        nextWord(true); // è‡ªå‹•çš„ãªç§»å‹•ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™
                        // å˜èªåˆ‡ã‚Šæ›¿ãˆå¾Œã€ã™ãã«å†ç”Ÿé–‹å§‹
                        setTimeout(() => {
                            if (isAutoPlaying) {
                                playCurrentWord();
                            }
                        }, 100);
                    }
                }, 500); // 0.5ç§’å¾…æ©Ÿ
            } else {
                // æ‰‹å‹•å†ç”Ÿãƒ¢ãƒ¼ãƒ‰ï¼šåœæ­¢
                const playBtn = document.getElementById('playBtn');
                playBtn.textContent = 'â–¶ å†ç”Ÿ';
            }
        }
        
        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
        function nextWord(isAuto = false) {
            try {
                if (!filteredVocabulary || filteredVocabulary.length === 0) return;

                // æ‰‹å‹•ã§ã®ã‚¹ãƒ©ã‚¤ãƒ‰å¤‰æ›´ã®å ´åˆ
                if (!isAuto) {
                    if (isPlaying) {
                        // å†ç”Ÿä¸­ãªã‚‰ä¸€æ—¦åœæ­¢
                        speechSynthesis.cancel();
                        isPlaying = false;
                    }
                }

                currentIndex = (currentIndex + 1) % filteredVocabulary.length;
                displayCurrentWord();

                // è‡ªå‹•å†ç”Ÿãƒ¢ãƒ¼ãƒ‰ã§æ‰‹å‹•å¤‰æ›´ã®å ´åˆã¯ã€ã™ãã«æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å†ç”Ÿ
                if (isAutoPlaying && !isAuto) {
                    setTimeout(() => {
                        playCurrentWord();
                    }, 200);
                }
            } catch (error) {
                console.error('æ¬¡ã®å˜èªã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function previousWord() {
            try {
                if (!filteredVocabulary || filteredVocabulary.length === 0) return;

                // å†ç”Ÿä¸­ãªã‚‰ä¸€æ—¦åœæ­¢
                if (isPlaying) {
                    speechSynthesis.cancel();
                    isPlaying = false;
                }

                currentIndex = (currentIndex - 1 + filteredVocabulary.length) % filteredVocabulary.length;
                displayCurrentWord();

                // è‡ªå‹•å†ç”Ÿãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€ã™ãã«æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å†ç”Ÿ
                if (isAutoPlaying) {
                    setTimeout(() => {
                        playCurrentWord();
                    }, 200);
                }
            } catch (error) {
                console.error('å‰ã®å˜èªã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // è‡ªå‹•å†ç”Ÿ
        function toggleAutoPlay() {
            try {
                isAutoPlaying = !isAutoPlaying;
                const autoBtn = document.getElementById('autoBtn');
                const playBtn = document.getElementById('playBtn');

                if (isAutoPlaying) {
                    // æ‰‹å‹•å†ç”Ÿä¸­ã®å ´åˆã¯åœæ­¢ã—ã¦ãƒªã‚»ãƒƒãƒˆ
                    if (isPlaying) {
                        isTransitioning = true; // åˆ‡ã‚Šæ›¿ãˆä¸­ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                        speechSynthesis.cancel();
                        isPlaying = false;
                        document.getElementById('audioIndicator').style.display = 'none';
                        setTimeout(() => { isTransitioning = false; }, 100); // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ•ãƒ©ã‚°ã‚’ä¸‹ã’ã‚‹
                    }

                    // å†ç”Ÿãƒœã‚¿ãƒ³ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ã«æˆ»ã™
                    playBtn.textContent = 'â–¶ å†ç”Ÿ';

                    // è‡ªå‹•ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                    autoBtn.textContent = 'â¸ åœæ­¢';
                    autoBtn.style.background = '#ff6b6b';

                    // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆå†ç”Ÿãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼‰
                    updateButtonStates();

                    // è‡ªå‹•å†ç”Ÿé–‹å§‹
                    startAutoPlay();
                } else {
                    autoBtn.textContent = 'â–¶ è‡ªå‹•';
                    autoBtn.style.background = '#667eea';
                    stopAutoPlay();
                }
            } catch (error) {
                console.error('è‡ªå‹•å†ç”Ÿåˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // Wake Lock å–å¾—ï¼ˆç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼‰
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('âœ“ Wake Lockå–å¾—æˆåŠŸ: ç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ON');
                    console.log('ğŸ’¡ ãƒãƒƒãƒ†ãƒªãƒ¼ç¯€ç´„ã®ãŸã‚ã€ç”»é¢ã®æ˜ã‚‹ã•ã‚’æœ€ä½ã«ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™');

                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lockè§£æ”¾');
                        wakeLock = null;
                    });
                } else {
                    console.log('âš ï¸ Wake Lock APIã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢æ©Ÿèƒ½ãŒä½¿ãˆã¾ã›ã‚“ï¼‰');
                }
            } catch (error) {
                console.error('Wake Lockå–å¾—ã‚¨ãƒ©ãƒ¼:', error.message);
            }
        }

        // Wake Lock è§£æ”¾
        async function releaseWakeLock() {
            try {
                if (wakeLock !== null) {
                    await wakeLock.release();
                    wakeLock = null;
                    console.log('âœ“ Wake Lockè§£æ”¾: ç”»é¢ã‚¹ãƒªãƒ¼ãƒ—è¨±å¯');
                }
            } catch (error) {
                console.error('Wake Lockè§£æ”¾ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function startAutoPlay() {
            try {
                // Wake Lockå–å¾—ï¼ˆç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼‰
                requestWakeLock();
                // è‡ªå‹•å†ç”Ÿé–‹å§‹
                playCurrentWord();
            } catch (error) {
                console.error('è‡ªå‹•å†ç”Ÿé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function stopAutoPlay() {
            try {
                // Wake Lockè§£æ”¾
                releaseWakeLock();
                // è‡ªå‹•å†ç”Ÿåœæ­¢
                pausePlayback();
                updateButtonStates();
            } catch (error) {
                console.error('è‡ªå‹•å†ç”Ÿåœæ­¢ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // è¨­å®šé–¢æ•°
        function showSettings() {
            document.getElementById('settingsPanel').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function hideSettings() {
            document.getElementById('settingsPanel').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
        function setupTouchEvents() {
            try {
                let touchStartX = 0;
                let touchStartY = 0;
                let touchEndX = 0;
                let touchEndY = 0;
                const slideContainer = document.getElementById('slideContainer');

                slideContainer.addEventListener('touchstart', e => {
                    // ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ãŸå ´åˆã¯ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®šã—ãªã„
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                        return;
                    }
                    touchStartX = e.changedTouches[0].screenX;
                    touchStartY = e.changedTouches[0].screenY;
                }, { passive: true });

                slideContainer.addEventListener('touchend', e => {
                    // ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ãŸå ´åˆã¯ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®šã—ãªã„
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                        return;
                    }
                    touchEndX = e.changedTouches[0].screenX;
                    touchEndY = e.changedTouches[0].screenY;

                    const swipeThreshold = 80; // é–¾å€¤ã‚’å¤§ããï¼ˆ50â†’80ï¼‰
                    const diffX = touchStartX - touchEndX;
                    const diffY = Math.abs(touchStartY - touchEndY);

                    // æ¨ªæ–¹å‘ã®å‹•ããŒé–¾å€¤ã‚’è¶…ãˆã€ã‹ã¤ç¸¦æ–¹å‘ã®å‹•ããŒå°ã•ã„å ´åˆã®ã¿ã‚¹ãƒ¯ã‚¤ãƒ—ã¨ã—ã¦èªè­˜
                    if (Math.abs(diffX) > swipeThreshold && diffY < 50) {
                        if (diffX > 0) {
                            nextWord();
                        } else {
                            previousWord();
                        }
                    }
                }, { passive: true });

                console.log('ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šå®Œäº†');
            } catch (error) {
                console.error('ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // èª­ã¿ä¸Šã’è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
        function resetPlaybackSettings() {
            try {
                document.getElementById('includeJpWord').checked = true;
                document.getElementById('includeEnWord').checked = true;
                document.getElementById('includeJpSentence').checked = true;
                document.getElementById('includeEnSentence').checked = true;
                document.getElementById('readOrderEnJp').checked = true;
                document.getElementById('englishRepeat2').checked = true;
                saveSettings();
                console.log('èª­ã¿ä¸Šã’è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('è¨­å®šãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // è¨­å®šä¿å­˜/èª­ã¿è¾¼ã¿
        function saveSettings() {
            try {
                const readOrderChecked = document.querySelector('input[name="readOrder"]:checked');
                const englishRepeatChecked = document.querySelector('input[name="englishRepeat"]:checked');

                const settings = {
                    speechRate: document.getElementById('speechRate').value,
                    randomMode: document.getElementById('randomMode').checked,
                    bookmarkMode: document.getElementById('bookmarkMode').checked,
                    category: document.getElementById('categorySelect').value,
                    // ã‚«ã‚¹ã‚¿ãƒ èª­ã¿ä¸Šã’è¨­å®š
                    includeJpWord: document.getElementById('includeJpWord').checked,
                    includeEnWord: document.getElementById('includeEnWord').checked,
                    includeJpSentence: document.getElementById('includeJpSentence').checked,
                    includeEnSentence: document.getElementById('includeEnSentence').checked,
                    readOrder: readOrderChecked ? readOrderChecked.value : 'en-jp',
                    englishRepeat: englishRepeatChecked ? englishRepeatChecked.value : '2'
                };
                localStorage.setItem('childWordSettings', JSON.stringify(settings));
            } catch (error) {
                console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function loadSettings() {
            try {
                const settings = localStorage.getItem('childWordSettings');
                if (settings) {
                    const parsed = JSON.parse(settings);
                    document.getElementById('speechRate').value = parsed.speechRate || '1.0';
                    document.getElementById('randomMode').checked = parsed.randomMode || false;
                    document.getElementById('bookmarkMode').checked = parsed.bookmarkMode || false;
                    document.getElementById('categorySelect').value = parsed.category || 'all';

                    // ã‚«ã‚¹ã‚¿ãƒ èª­ã¿ä¸Šã’è¨­å®šã®å¾©å…ƒï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚ã‚Šï¼‰
                    document.getElementById('includeJpWord').checked = parsed.includeJpWord !== undefined ? parsed.includeJpWord : true;
                    document.getElementById('includeEnWord').checked = parsed.includeEnWord !== undefined ? parsed.includeEnWord : true;
                    document.getElementById('includeJpSentence').checked = parsed.includeJpSentence !== undefined ? parsed.includeJpSentence : true;
                    document.getElementById('includeEnSentence').checked = parsed.includeEnSentence !== undefined ? parsed.includeEnSentence : true;

                    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å¾©å…ƒ
                    const readOrder = parsed.readOrder || 'en-jp';
                    if (readOrder === 'en-jp') {
                        document.getElementById('readOrderEnJp').checked = true;
                    } else {
                        document.getElementById('readOrderJpEn').checked = true;
                    }

                    const englishRepeat = parsed.englishRepeat || '2';
                    if (englishRepeat === '2') {
                        document.getElementById('englishRepeat2').checked = true;
                    } else {
                        document.getElementById('englishRepeat1').checked = true;
                    }

                    isBookmarkMode = parsed.bookmarkMode || false;
                    toggleRandomMode();
                    changeCategory();
                }
            } catch (error) {
                console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            try {
                ['speechRate', 'randomMode', 'bookmarkMode', 'categorySelect'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', saveSettings);
                    }
                });

                // ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºçŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸã¨ã
                document.addEventListener('visibilitychange', async () => {
                    if (document.hidden) {
                        console.log('ãƒšãƒ¼ã‚¸ãŒéè¡¨ç¤ºã«ãªã‚Šã¾ã—ãŸ');
                        // Wake Lockã¯è‡ªå‹•çš„ã«è§£æ”¾ã•ã‚Œã‚‹
                    } else {
                        console.log('ãƒšãƒ¼ã‚¸ãŒå†è¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
                        // è‡ªå‹•å†ç”Ÿä¸­ãªã‚‰Wake Lockã‚’å†å–å¾—
                        if (isAutoPlaying && wakeLock === null) {
                            await requestWakeLock();
                        }
                    }
                });

                console.log('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
            } catch (error) {
                console.error('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // Service Workerç™»éŒ²ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰
        // HTTPSã¾ãŸã¯localhostã§ã®ã¿å‹•ä½œ
        if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('âœ“ Service Workerç™»éŒ²æˆåŠŸ:', registration.scope);
                        console.log('ğŸ’¡ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚ä½¿ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ');
                    })
                    .catch(error => {
                        console.log('Service Workerç™»éŒ²å¤±æ•—:', error);
                        console.log('ğŸ’¡ file://ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã¯Service Workerã¯å‹•ä½œã—ã¾ã›ã‚“');
                        console.log('ğŸ’¡ ãŸã ã—ã€ã‚¢ãƒ—ãƒªã¯é€šå¸¸é€šã‚Šä½¿ç”¨ã§ãã¾ã™');
                    });
            });
        } else if (location.protocol === 'file:') {
            console.log('ğŸ’¡ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦é–‹ã‹ã‚Œã¦ã„ã¾ã™');
            console.log('ğŸ’¡ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã¯åˆ¶é™ã•ã‚Œã¾ã™ãŒã€ã‚¢ãƒ—ãƒªã¯ä½¿ç”¨ã§ãã¾ã™');
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.addEventListener('load', () => {
            console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            setTimeout(() => {
                setupEventListeners();
                initializeApp();
            }, 100);
        });
        
        // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æ©Ÿèƒ½
        function getWordKey(word) {
            return `${word.jp}_${word.en}`;
        }

        function toggleBookmark() {
            try {
                if (!filteredVocabulary || filteredVocabulary.length === 0) return;

                const actualIndex = isRandomMode ? randomIndexes[currentIndex] : currentIndex;
                const word = filteredVocabulary[actualIndex];
                if (!word) return;

                const wordKey = getWordKey(word);

                if (bookmarkedWords.has(wordKey)) {
                    bookmarkedWords.delete(wordKey);
                } else {
                    bookmarkedWords.add(wordKey);
                }

                saveBookmarks();
                updateBookmarkButton();

                console.log(`ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ ${bookmarkedWords.has(wordKey) ? 'è¿½åŠ ' : 'å‰Šé™¤'}:`, word.jp);
            } catch (error) {
                console.error('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function updateBookmarkButton() {
            try {
                if (!filteredVocabulary || filteredVocabulary.length === 0) return;

                const actualIndex = isRandomMode ? randomIndexes[currentIndex] : currentIndex;
                const word = filteredVocabulary[actualIndex];
                if (!word) return;

                const wordKey = getWordKey(word);
                const btn = document.getElementById('bookmarkBtn');

                if (!btn) return; // ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

                if (bookmarkedWords.has(wordKey)) {
                    btn.textContent = 'â˜…';
                } else {
                    btn.textContent = 'â˜†';
                }
            } catch (error) {
                console.error('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒœã‚¿ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function toggleBookmarkMode() {
            try {
                isBookmarkMode = document.getElementById('bookmarkMode').checked;
                console.log(`ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: ${isBookmarkMode ? 'ON' : 'OFF'}`);

                changeCategory();
                saveSettings();
            } catch (error) {
                console.error('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function applyBookmarkFilter() {
            try {
                filteredVocabulary = filteredVocabulary.filter(word => {
                    const wordKey = getWordKey(word);
                    return bookmarkedWords.has(wordKey);
                });

                console.log(`ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨: ${filteredVocabulary.length}èª`);
            } catch (error) {
                console.error('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ•ã‚£ãƒ«ã‚¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function saveBookmarks() {
            try {
                const bookmarksArray = Array.from(bookmarkedWords);
                localStorage.setItem('childWordBookmarks', JSON.stringify(bookmarksArray));
                console.log(`ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä¿å­˜: ${bookmarksArray.length}èª`);
            } catch (error) {
                console.error('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function loadBookmarks() {
            try {
                const saved = localStorage.getItem('childWordBookmarks');
                if (saved) {
                    const bookmarksArray = JSON.parse(saved);
                    bookmarkedWords = new Set(bookmarksArray);
                    console.log(`ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯èª­ã¿è¾¼ã¿: ${bookmarkedWords.size}èª`);
                }
            } catch (error) {
                console.error('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // å˜èªæ¤œç´¢æ©Ÿèƒ½
        function searchWord() {
            try {
                const searchText = document.getElementById('searchInput').value.trim().toLowerCase();
                const searchResultDiv = document.getElementById('searchResult');

                if (!searchText) {
                    searchResultDiv.textContent = 'æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                    searchResultDiv.style.display = 'block';
                    searchResultDiv.style.background = '#fff3cd';
                    searchResultDiv.style.color = '#856404';
                    return;
                }

                // vocabularyå…¨ä½“ã‹ã‚‰æ¤œç´¢
                let foundIndex = -1;
                let foundWord = null;

                for (let i = 0; i < vocabulary.length; i++) {
                    const word = vocabulary[i];
                    const jpMatch = word.jp.toLowerCase().includes(searchText);
                    const enMatch = word.en.toLowerCase().includes(searchText);
                    const jpExampleMatch = word.exampleJp.toLowerCase().includes(searchText);
                    const enExampleMatch = word.exampleEn.toLowerCase().includes(searchText);

                    if (jpMatch || enMatch || jpExampleMatch || enExampleMatch) {
                        foundIndex = i;
                        foundWord = word;
                        break;
                    }
                }

                if (foundIndex === -1) {
                    searchResultDiv.textContent = 'ã€Œ' + searchText + 'ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
                    searchResultDiv.style.display = 'block';
                    searchResultDiv.style.background = '#f8d7da';
                    searchResultDiv.style.color = '#721c24';
                    return;
                }

                // è¦‹ã¤ã‹ã£ãŸå˜èªã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
                const foundCategory = foundWord.category;
                document.getElementById('categorySelect').value = foundCategory;

                // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
                if (foundCategory === 'all') {
                    filteredVocabulary = vocabulary;
                } else {
                    filteredVocabulary = vocabulary.filter(word => word.category === foundCategory);
                }

                // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã•ã‚‰ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (isBookmarkMode) {
                    applyBookmarkFilter();
                }

                // ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†ç”Ÿæˆ
                if (isRandomMode) {
                    generateRandomIndexes();
                }

                // filteredVocabularyå†…ã§ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹
                let targetIndex = -1;
                for (let i = 0; i < filteredVocabulary.length; i++) {
                    if (filteredVocabulary[i] === foundWord) {
                        targetIndex = i;
                        break;
                    }
                }

                if (targetIndex === -1) {
                    // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§
                    searchResultDiv.textContent = 'ã€Œ' + foundWord.jp + ' / ' + foundWord.en + 'ã€ã¯ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã•ã‚Œã¦ã„ã¾ã›ã‚“';
                    searchResultDiv.style.display = 'block';
                    searchResultDiv.style.background = '#fff3cd';
                    searchResultDiv.style.color = '#856404';
                    return;
                }

                currentIndex = targetIndex;
                displayCurrentWord();

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                searchResultDiv.textContent = 'ã€Œ' + foundWord.jp + ' / ' + foundWord.en + 'ã€ã«ç§»å‹•ã—ã¾ã—ãŸ';
                searchResultDiv.style.display = 'block';
                searchResultDiv.style.background = '#d4edda';
                searchResultDiv.style.color = '#155724';

                // è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
                setTimeout(() => {
                    hideSettings();
                    searchResultDiv.style.display = 'none';
                    document.getElementById('searchInput').value = '';
                }, 1500);

            } catch (error) {
                console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                const searchResultDiv = document.getElementById('searchResult');
                searchResultDiv.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                searchResultDiv.style.display = 'block';
                searchResultDiv.style.background = '#f8d7da';
                searchResultDiv.style.color = '#721c24';
            }
        }

        // Enterã‚­ãƒ¼ã§æ¤œç´¢
        window.addEventListener('load', () => {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchWord();
                    }
                });
            }
        });

        // ãƒ‡ãƒãƒƒã‚°ç”¨
        window.debugInfo = () => {
            console.log('--- ãƒ‡ãƒãƒƒã‚°æƒ…å ± ---');
            console.log('èªå½™ãƒ‡ãƒ¼ã‚¿:', vocabulary ? vocabulary.length + 'èª' : 'æœªå®šç¾©');
            console.log('ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚ŒãŸèªå½™:', filteredVocabulary ? filteredVocabulary.length + 'èª' : 'æœªå®šç¾©');
            console.log('ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', currentIndex);
            console.log('ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰:', isRandomMode);
            console.log('1å˜èªãƒ¢ãƒ¼ãƒ‰:', isSingleWordMode);
            console.log('è‡ªå‹•å†ç”Ÿ:', isAutoPlaying);
            console.log('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æ•°:', bookmarkedWords.size);
            console.log('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰:', isBookmarkMode);
        };
    </script>
</body>
</html>
